<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>lab</title>
    <meta name="description" content="lab">
    <meta name="author" content="SitePoint">
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->
    <script src="/__/firebase/6.6.1/firebase-app.js"></script>
    <script src="/__/firebase/6.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.3.4/firebase-firestore.js"></script>
    <script src="/__/firebase/init.js"></script>
  </head>
  <body>
    <h1 id='b_createGroup'>[Create a group]</h1>
    <h1 id='b_showUserData'>[Show user data (properties)]</h1>
    <h1 id='b_initUser'>[Initialize users/user.uid to connect userid and groupid]</h1>
    <h1 id='b_CheckUserInitState'>[Check if currentUser has never init UserData]</h1>
    <h1 id='b_4'>show group infos (not yet)</h1>

    <hr>
    <input id='textbox'>
    <span id='saveMessage'>[SEND]</span><br>
    <span id='messages_box'></span>
    <hr>
    <h1 id='messages'>messages will be shown here:</h1>
    <script>
var currentUserObject;
/*
 **********UNIGOKON SETTING FROM HERE*********
 */
//document.getElementByIDの省略処理
function addOnclickEvent(cssid, onclickFunction) {
  document.getElementById(cssid).onclick = onclickFunction
}

//modifyHTML) 任意idに対してHTML書き換えの関数を準備
function modifyHTML(cssid, content_modific) {
  document.getElementById(cssid).innerHTML = content_modific
}
//note firebase app initializatinoはinit.jsを読み込めば実行する必要はない
var db = firebase.firestore();
/*デバッグ時に変更が適用されたかどうかを以下でチェック*/
//後々実名変更回数制限を設ける
//今は実装しない
//グループプロファイルのplaceholderつくる
//初回ログイン時にphotoURLをplaceholderのURLにする
var user = firebase.auth().currentUser;
/*
 **********UNIGOKON SETTING END HERE**********
 */
var currentGroupSelected=1
function saveUserObjectIntoVariable(users_path) {
  db.collection("users").doc(users_path).get().then(function (doc) {
    console.log('recieved usersObject successfully')
    currentUserObject = doc.data()
  }).then(function () {
    //todo create a group object
    //you need to specify which group you wanna save object into a variable

  console.log('UserObject successfully saved into currentUserObject',currentUserObject)

  //currentUserObjectをセットアップしてから、currentUserObjectのgroupID[0]に応じてグループあるかないか判断
  //check if user has group already or not
  if(currentUserObject.groupID[0]=="NOGROUPS"){
    alert("you dont have any group")
  }else{
    alert("you already have at least one group")
  }
  /*
  if(){
    alert("no groups!")
  } 
  */
  db.collection("groups").doc(currentUserObject.groupID[currentGroupSelected]).get().then(function (doc) {
    console.log('groupObject saved into a variable', doc.data())
    currentGroupObject = doc.data()
    //group [0]="NOGROUPS"

  })
  })
}


firebase.auth().onAuthStateChanged(authStateObserver)


function authStateObserver(user) {
  if (user) {
    console.log('login status: in')
    /*
    ************************************************
    以下firebase.auth().currentUserオブジェクト関連の処理はこのレベルに配置せよ
    Firebase公式ドキュメントによるとonAuthStateChangedオブザーバーによる処理が推奨されている
    ************************************************
    */
    //firestore read and write tests here
    //CREATING A GROUP
    //TODO:adding multiple groups
    addOnclickEvent('b_showUserData', function () {
      modifyHTML('messages', currentUserObject.groupID)
      //console.log(currentUserObject)
    })
    addOnclickEvent('b_createGroup', function () {
      //users docにメアドと名前を追加
      //現段階では書き込みテストができればそれでいいい
      //最終的にはserverTimeStampで最終更新のタイミングも保存する
      //*******************
      //DEF createGroup(creating a group and writing the generated group id into users/groupID)
      //*******************
      //create a group      
      function createGroup(groupData) {
        //
        //todo 取得をdoc()でやってみる
        db.collection('groups').add(groupData).then(function (docRef) {
          console.log("groupData successfully written into 'groups/' (groupid generated randomly)");
          console.log("generated groupid in 'groups':" + docRef.id)
          //user.idに１つ割り当てられるcollectionにアクセスしdocRefを記録する処理
          //user info update here
          //users/[uid]/groupIDが存在している場合を前提としている
          // groupIDをusers/DKDJSkdfj groupIDにほぞん
          db.collection('users').doc(user.uid).update({
                    name: "defaultName(indivisual name, not groupvname )",
        mail: user.email,
            groupID: firebase.firestore.FieldValue.arrayUnion(docRef.id)
          }).then(function () {
            console.log('group id has been stored into users/[uid]/groupID')
          });
        })
      }
      //Actually creating a group here:
      createGroup({
        groupName: 'グループの名前',
        avatarImage: 'URL',
        numberOfPeople: 3,
        profiles: [{
          name: 'takashi',
          age: 5,
          locationInPicture: 'jijki'
        }, {
          name: 'takeda',
          age: 10,
          locationInPicture: '下の方'
        }],
        groupProfile: "I'm looking forward to seeing you guys!",
        accountID: user.uid
      })
      //currentUserObjectの更新
      saveUserObjectIntoVariable(user.uid)
      /*
            //get data with specified groupID and save them into js dictionary
          function getGroupData{}
            //modify a group with specified group id
          }
          function modifyGroup(groupID,groupData){  

          }
      */
    })
    //showGroupsはユーザが作成したグループの一覧の配列を返す
    //showGroups().groupName のように値を取り出したい
    //ここはユーザのobjectのみ
    //readUserOb//*******************ject(user.uid).groupID[1]
    //users , groups object作ればいいのか
    //firestore/users/[uid]の配列を読み取りのみで変数にほぞん
    //USER OBJECT SETUP (read only)
    //currentUserObjectはグローバル変数にしている
    //これは必要　
    saveUserObjectIntoVariable(user.uid)
    //*********この実行タイミングがうまくできていない
    //*********このsetupの配置を考え直す
    /*
    //GROUP OBJECT SETUP (read only)
    var currentGroupObject;
    savaGroupObjectIntoVariable()
    function savaGroupObjectIntoVariable(groupID) {
      var groupsObject_firestore_users;
      db.collection("groups").doc(currentUserObject.groupID).get().then(function (doc) {
        console.log('groupsObject saved into a variable',doc.data())
        currentGroupObject = doc.data()
      })
    }
    */
    //InitUserID function def
    function initUserData() {
      //groupIDがないときはUserDataInit()で初期設定
      //w/o initUseData, only group data is stored and group id will not stored in users/uid
      db.collection('users').doc(user.uid).update({
        name: "defaultName(indivisual name, not groupvname )",
        mail: user.email,
        groupID: ["NOGROUPS"]
      }).then(function () {
        console.log("UserData successfully Initialized");
      }).catch(function (error) {
        console.error("UserData initilization Error: ", error);
      })
    }

    function checkUserInitState() {
      //userUidが存在するかどうかを判断基準にする
      //checkUserInitState returns true or false
      //so you can use it with if statement.
      //以下の無名関数でreturn true or falseしてもcheckUserInitStateでなく無名関数で returnされるためreturn_boolを設定
      var return_bool;
      db.collection('users').doc(user.uid).get().then(function (doc) {
        if (doc.exists) {
          console.log("already Initialized this user", doc.data());
          return_bool = true;
        } else {
          // doc.data() will be undefined in this case
          console.log("currentuser needs to be Initialized");
          return_bool = false
        }
      }).catch(function (error) {
        console.log("Error getting document:", error);
      });
      if (return_bool = true) {
        return true
      } else {
        return false
      }
    }
    //Check Init User
    addOnclickEvent('b_CheckUserInitState', function () {
      checkUserInitState();
    })
    //InitUserID
    addOnclickEvent('b_initUser', function () {
      initUserData()
    })
    //*******2019_11_10 chat functions
    //def saveMessage to save a new message
    //***assume that data structures have been appropriately setuped. 
    //todo use doc to create a reference to appropriate paths.
    // Loads chat messages history and listens for upcoming ones.



    /* MESSAGE FUNCTIONS FROM HERE!
    //saveMessage setup
    function saveMessage(messageText) {
      console.log('saveMessage executed line 210')
      return firebase.firestore().collection('chatrooms').doc('testchatroomID').collection('messages').add({
        //name: currentUserObject.name + '(「' + currentGroupObject.groupName + '」の幹事)',
        uid: user.uid,
        text: messageText,
        profilePicUrl: 'test profilePicUrl',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).catch(function (error) {
        console.error('Error writing new message to database', error)
      })
    }
    //getting info from input tag
    //Saving a new message test exceting
    addOnclickEvent('saveMessage', function () {
      saveMessage(document.getElementById('textbox').value)
      document.getElementById('textbox').value=''
    })
    //*******

    var messagesRef = db.collection("chatrooms").doc("testchatroomID").collection("messages");
  
//***********同期処理

    messagesRef.orderBy("timestamp", "desc").onSnapshot( (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        // 追加
        if ( change.type === 'added' ) {
          if(change.doc.data()['timestamp']!=null){
            console.log(change.doc.id, change.doc.data()['text']);


          }
          //displayMessage
          var div=document.createElement('div')
          div.setAttribute('id', change.doc.id);
          document.getElementById('messages_box').appendChild(div)
          document.getElementById(change.doc.id).innerHTML=`${change.doc.data()['text']}`


        }
        // 更新
        else if( change.type === 'modified' ){
          console.log(change.doc.id, change.doc.data());
        }
        // 削除
        else if ( change.type === 'removed' ) {
          console.log(change.doc.id);
        }
      });
    })

    */




  } else {
    console.log('login status: out')
    alert('ログインしていません')
    window.location.href = 'index.html'
  }
}


//todo html書き換え
</script>　
<script>

</script>
  </body>
</html>